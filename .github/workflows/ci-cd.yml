# Add this comment
# Final attempt to ensure environment setup is recognized

name: CI/CD Pipeline for Portfolio Site
# ... (rest of the file content)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    # --- START CRITICAL FIX ---
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    # --- END CRITICAL FIX ---
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Install dependencies
        # Use 'npm ci' for clean, consistent installs in CI/CD environments.
        run: npm ci

      # 4. FIX: Ensure tests don't exit with code 0 if they fail, 
      # which would cause the build step to run but potentially with a broken state.
      # If your 'npm test' passes, this step is fine. If it fails and 
      # your workflow proceeds, it's a configuration issue in your test script.
      - name: 4. Run tests (Must pass or fail fast)
        run: npm test
        # NOTE: If your test framework (like Jest) is configured to ignore failures, 
        # this step might be succeeding but leading to a broken build.

      # 5. REMOVED: The 'npm run build' command typically handles 
      # running binaries from node_modules/.bin automatically. 
      # The explicit 'chmod' step is rarely necessary and can be removed for simplicity.
      # - name: 5. Ensure build tools are executable
      #   run: chmod +x node_modules/.bin/vite

      - name: 6. Build project (CRITICAL STEP)
        # This step is correct, assuming 'npm run build' in your package.json 
        # correctly runs your Vite/other bundler command to create the './dist' folder.
        run: npm run build

      - name: 7. Setup Pages
        uses: actions/configure-pages@v5

      - name: 8. Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build'
          # CRITICAL CHECK: Ensure this path is correct. 
          # Some frameworks use 'build' or 'out' instead of 'dist'.

      - name: 9. Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4